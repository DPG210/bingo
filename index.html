<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Bingo Player - dpg210</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <style>
        :root { --dark: #1a1a2e; --accent: #e94560; --win: #27ae60; --paper: #ffffff; }
        body { background: var(--dark); color: white; font-family: sans-serif; text-align: center; margin: 0; padding: 15px; }
        #login-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 80vh; }
        .login-box { background: #16213e; padding: 30px; border-radius: 15px; width: 85%; max-width: 350px; }
        #game-screen { display: none; }
        input { padding: 15px; border-radius: 8px; border: none; width: 90%; margin-bottom: 20px; font-size: 1.1rem; text-align: center; }
        .btn { border: none; padding: 15px; border-radius: 10px; color: white; font-weight: bold; cursor: pointer; font-size: 1.1rem; width: 100%; transition: 0.2s; }
        .btn-linea { background: var(--win); margin-right: 5px; }
        .btn-bingo { background: var(--accent); }
        .last-ball { background: white; color: var(--dark); width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; font-weight: bold; margin: 15px auto; border: 4px solid var(--accent); }
        .grid { display: grid; grid-template-columns: repeat(9, 1fr); background: #2c3e50; gap: 2px; border: 2px solid #2c3e50; }
        .cell { background: white; aspect-ratio: 1; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 1.3rem; cursor: pointer; color: #333; position: relative; -webkit-tap-highlight-color: transparent; }
        .empty { background: #f0f0f0; }
        .marked::after { content: ""; position: absolute; width: 75%; height: 75%; border: 4px solid rgba(231, 76, 60, 0.7); border-radius: 50%; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h2 style="color: var(--accent)">BINGO ONLINE</h2>
            <input type="text" id="nick-input" placeholder="Introduce tu Nick">
            <button class="btn btn-bingo" onclick="entrar()">ENTRAR A JUGAR</button>
        </div>
    </div>

    <div id="game-screen">
        <div style="display:flex; max-width:600px; margin:auto;">
            <button class="btn btn-linea" onclick="enviarAviso('LÍNEA')">¡LÍNEA!</button>
            <button class="btn btn-bingo" onclick="enviarAviso('BINGO')">¡BINGO!</button>
        </div>
        <div class="last-ball" id="last-ball">--</div>
        <div class="ticket"><div class="grid" id="carton"></div></div>
        <p id="info-player" style="color: #888; margin-top:10px;"></p>
    </div>

    <script>
        const firebaseConfig = { databaseURL: "https://bingov3-1ec3a-default-rtdb.europe-west1.firebasedatabase.app/" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const sala = new URLSearchParams(window.location.search).get('sala') || "TEST";

        let miNick = localStorage.getItem('bingo_nick') || "";
        const storageKey = `bingo_carton_${sala}`;

        function entrar() {
            miNick = document.getElementById('nick-input').value.trim();
            if(!miNick) return alert("Escribe un nombre");
            localStorage.setItem('bingo_nick', miNick);
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('game-screen').style.display = 'block';
            document.getElementById('info-player').innerText = "Jugador: " + miNick;
            init();
        }

        function init() {
            let matrix = JSON.parse(localStorage.getItem(storageKey)) || generar();
            render(matrix);
        }

        function generar() {
            const m = Array(3).fill().map(() => Array(9).fill(null));
            const cols = Array(9).fill().map((_, i) => {
                let min = i*10 + (i==0?1:0), max = i==8?90:i*10+9;
                let ns = []; while(ns.length<3){let n=Math.floor(Math.random()*(max-min+1))+min; if(!ns.includes(n)) ns.push(n);}
                return ns.sort((a,b)=>a-b);
            });
            for(let f=0; f<3; f++) {
                let c_oc = 0; while(c_oc < 5) {
                    let c = Math.floor(Math.random()*9);
                    if(!m[f][c]) { m[f][c] = { v: cols[c].shift(), m: false }; c_oc++; }
                }
            }
            localStorage.setItem(storageKey, JSON.stringify(m));
            return m;
        }

        function render(m) {
            const cont = document.getElementById('carton'); cont.innerHTML = '';
            m.forEach((fila, f) => fila.forEach((celda, c) => {
                const div = document.createElement('div');
                div.className = celda ? `cell ${celda.m ? 'marked' : ''}` : 'cell empty';
                if(celda) { 
                    div.innerText = celda.v; 
                    div.onclick = () => { celda.m = !celda.m; localStorage.setItem(storageKey, JSON.stringify(m)); render(m); };
                }
                cont.appendChild(div);
            }));
        }

        function enviarAviso(tipo) {
            db.ref(`Salas/${sala}/Aviso`).set({
                jugador: miNick,
                tipo: tipo,
                t: Date.now() // Timestamp para forzar actualización en la App
            }).then(() => {
                alert("Aviso de " + tipo + " enviado correctamente");
            });
        }

        db.ref(`Salas/${sala}/Ultima`).on('value', snap => {
            if(snap.val()) document.getElementById('last-ball').innerText = snap.val();
        });
    </script>
</body>
</html>