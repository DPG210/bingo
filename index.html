<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Bingo Player - dpg210</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <style>
        :root { --paper: #ffffff; --dark: #1a1a2e; --accent: #e94560; --win: #27ae60; }
        body { background: var(--dark); color: white; font-family: sans-serif; text-align: center; margin: 0; padding: 15px; }
        
        .setup-section { margin-bottom: 20px; background: #16213e; padding: 15px; border-radius: 10px; }
        input { padding: 10px; border-radius: 5px; border: none; width: 80%; max-width: 300px; margin-bottom: 10px; font-size: 1rem; }
        
        .action-buttons { display: flex; gap: 10px; max-width: 500px; margin: 0 auto 20px auto; }
        .btn { border: none; padding: 15px; border-radius: 10px; color: white; font-weight: bold; flex: 1; cursor: pointer; font-size: 1.1rem; }
        .btn-linea { background: var(--win); }
        .btn-bingo { background: var(--accent); }

        .last-num-container { background: white; color: var(--dark); width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; font-weight: bold; margin: 10px auto; border: 4px solid var(--accent); }
        
        .ticket { background: var(--paper); padding: 10px; border-radius: 8px; max-width: 600px; margin: auto; border: 3px solid #2c3e50; }
        .grid { display: grid; grid-template-columns: repeat(9, 1fr); background: #2c3e50; gap: 2px; }
        .cell { background: white; aspect-ratio: 1; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 1.2rem; cursor: pointer; color: #333; position: relative; }
        .empty { background: #f0f0f0; }
        .marked::after { content: ""; position: absolute; width: 70%; height: 70%; border: 4px solid rgba(231, 76, 60, 0.7); border-radius: 50%; }
    </style>
</head>
<body>

    <div class="setup-section">
        <input type="text" id="nick-name" placeholder="Escribe tu Nick aquí...">
        <div class="action-buttons">
            <button class="btn btn-linea" onclick="cantar('LÍNEA')">¡LÍNEA!</button>
            <button class="btn btn-bingo" onclick="cantar('BINGO')">¡BINGO!</button>
        </div>
    </div>

    <div class="last-num-container" id="last-ball">--</div>
    
    <div class="ticket">
        <div class="grid" id="carton"></div>
    </div>

    <p style="color: #888; font-size: 0.8rem; margin-top: 15px;">SALA: <span id="sala-id">...</span></p>

    <script>
        const firebaseConfig = { databaseURL: "https://bingov3-1ec3a-default-rtdb.europe-west1.firebasedatabase.app/" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const sala = new URLSearchParams(window.location.search).get('sala') || "TEST";
        document.getElementById('sala-id').innerText = sala;

        // --- PERSISTENCIA Y GENERACIÓN ---
        const storageKey = `bingo_carton_${sala}`;
        let miCarton = JSON.parse(localStorage.getItem(storageKey)) || generarEstructura();

        function generarEstructura() {
            const matrix = Array(3).fill().map(() => Array(9).fill(null));
            const cols = Array(9).fill().map((_, i) => {
                let min = i * 10 + (i === 0 ? 1 : 0);
                let max = i === 8 ? 90 : i * 10 + 9;
                let nums = [];
                while(nums.length < 3) {
                    let n = Math.floor(Math.random() * (max - min + 1)) + min;
                    if(!nums.includes(n)) nums.push(n);
                }
                return nums.sort((a,b) => a-b);
            });
            for(let f=0; f<3; f++) {
                let c_ocupadas = 0;
                while(c_ocupadas < 5) {
                    let c = Math.floor(Math.random() * 9);
                    if(!matrix[f][c]) { matrix[f][c] = { valor: cols[c].shift(), marcado: false }; c_ocupadas++; }
                }
            }
            localStorage.setItem(storageKey, JSON.stringify(matrix));
            return matrix;
        }

        function toggle(f, c) {
            if(miCarton[f][c]) {
                miCarton[f][c].marcado = !miCarton[f][c].marcado;
                localStorage.setItem(storageKey, JSON.stringify(miCarton));
                render();
            }
        }

        function render() {
            const container = document.getElementById('carton');
            container.innerHTML = '';
            miCarton.forEach((fila, f) => fila.forEach((celda, c) => {
                const div = document.createElement('div');
                div.className = celda ? `cell ${celda.marcado ? 'marked' : ''}` : 'cell empty';
                if(celda) { div.innerText = celda.valor; div.onclick = () => toggle(f,c); }
                container.appendChild(div);
            }));
        }

        function cantar(tipo) {
            const nick = document.getElementById('nick-name').value;
            if(!nick) return alert("Ponte un nick primero");
            db.ref(`Salas/${sala}/Aviso`).set({ jugador: nick, tipo: tipo, t: Date.now() });
        }

        render();
        db.ref(`Salas/${sala}/Ultima`).on('value', snap => {
            if(snap.val()) document.getElementById('last-ball').innerText = snap.val();
        });
    </script>
</body>
</html>